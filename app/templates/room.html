<html lang="en-US">
    <head>
            <title>{{ room.title[0] }} - Lich: {{ room.id }} - UID: {{ room.uid | first }}</title>
            <link rel="stylesheet" href="static/css/pico.min.css">
            <link rel="stylesheet" href="static/css/prism.css">
            <link rel="stylesheet" href="static/css/room.css">
            <style>
                #highlight_box {
                    width:{{ room_box.width }}px;
                    height:{{ room_box.height }}px;
                    margin-top:{{ room_box.y + 0 }}px;
                    margin-left:{{ room_box.x + 0 }}px;
                }

                #mapimage {
                    height:{{ image_dimensions.height }};
                }
            </style>
    </head>
    <body>
        <script src="static/js/prism.js"></script>
        <div id="navigation_header">
            <div id="map_navigation">
                <select id="map_dropdown" onchange="navigateToMap()">
                    <option value="">Navigate to map...</option>
                    {% for category, maps in available_maps %}
                    <optgroup label="{{ category }}">
                        {% for map_name, room_id in maps %}
                        <option value="{{ room_id }}">{{ map_name }}</option>
                        {% endfor %}
                    </optgroup>
                    {% endfor %}
                </select>
                {% if adjacent_maps %}
                <select id="adjacent_map_dropdown" onchange="navigateToAdjacentMap()">
                    <option value="">Adjacent maps...</option>
                    {% for map_image, map_data in adjacent_maps %}
                    <option value="{{ map_data.room_id }}">{{ map_data.display_name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <a href="#search_section" id="search_link">Search...</a>
            </div>
        </div>
        <div id="header">
                <div id="title_row">
                    <h3>{{ room.title[0] }} - Lich: {{ room.id }} - UID: u{{ room.uid | first }}</h3>
                    {% if room.image %}
                    <div id="opacity_toggle">
                        <input type="checkbox" id="opacity_checkbox" onchange="toggleOpacity()">
                        <label for="opacity_checkbox">Toggle opacity</label>
                    </div>
                    {% endif %}
                </div>
                {% if room.image and image_tags %}
                <div id="tag_selector">
                    <label for="tag_dropdown">Highlight tag:</label>
                    <select id="tag_dropdown" onchange="highlightRooms()">
                        <option value="">Select a tag...</option>
                        {% for tag in image_tags %}
                        <option value="{{ tag }}">{{ tag }}</option>
                        {% endfor %}
                    </select>
                    <label for="location_dropdown">Highlight location:</label>
                    <select id="location_dropdown" onchange="highlightRooms()">
                        <option value="">Select a location...</option>
                        {% for location in image_locations %}
                        <option value="{{ location }}">{{ location }}</option>
                        {% endfor %}
                    </select>
                    <span id="help_icon" onclick="showHelpPopup()">?</span>
                </div>
                {% endif %}
        </div>
        {% if room.image %}
        <div id="help_popup" style="display: none;">
            <div id="help_popup_content">
                <span id="help_close" onclick="hideHelpPopup()">Ã—</span>
                <h4>Room Highlight Examples</h4>
                <div class="help_example">
                    <div class="help_highlight highlight_box_example"></div>
                    <span>Current room</span>
                </div>
                <div class="help_example">
                    <div class="help_highlight tag_highlight_box_example"></div>
                    <span>Tag highlight</span>
                </div>
                <div class="help_example">
                    <div class="help_highlight location_highlight_box_example"></div>
                    <span>Location highlight</span>
                </div>
                <div class="help_example">
                    <div class="help_highlight both_highlight_box_example"></div>
                    <span>Tag + location highlight</span>
                </div>
            </div>
        </div>
        <div id="image_wrapper">
            <div id="highlight_box" class="highlight_box">
                <!-- drawing highlight box-->
            </div>
            <img id="mapimage" src="{{url_for('static', filename='maps/' + room.image)}}">
        </div>
        {% endif %}
        <div id=after_image>
            <div id=desc_table_div class=after_table_divs>
                <table id=desc_table class=after_tables>
                    <tr>
                        <td colspan=10>{{ (room.description | default(["None"]))[0] }}</td>
                    </tr>
                    <tr>
                        <td colspan=10>{{ (room.paths | default(["Obvious paths: none"]))[0] }}</td>
                    </tr>
                    <tr>
                        <td colspan=10>Map: {{ room.image }}</td>
                    </tr>
                    <tr><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"><td bgcolor="#bbc6ce"></tr>
                    <tr>
                        <th colspan=9>
                            Exit
                        </th>
                        <th>
                            Connecting Room
                        </th>
                    </tr>
                {% for room_exit, room_way in room.wayto.items() %}
                    <tr>
                        <td colspan=9>
                            {{ room_way }}
                        </td>
                        <td>
                            <a href="{{ room_exit }}">{{ room_exit }}</a>
                        </td>
                    </tr>
                {% endfor %}
                </table>
            </div>
            <div id=full_info_div>
                <details id=full_info_details>
                    <summary>Full Room Info</summary>
                    <article id=full_info_article>
                        <code id=full_info_code class="language-json">{{ room_json_pretty }}</code>
                    </article>
                </details>
            </div>
            <div id="search_section" style="padding-left: 15px;">
                {% with results=None, overflow=False %} {% include "search_block.html" %} {% endwith %}
            </div>
            <div id=updated_at>
                <small><i>MapDB last updated: {{ updated_at }}</i></small>
            </div>
        </div>

        <script>
            // Room data for tag highlighting
            const sameImageRooms = {{ same_image_rooms | tojson }};
            const currentImageDimensions = {{ image_dimensions | tojson }};

            // Check for highlight parameters and pre-select dropdowns
            const urlParams = new URLSearchParams(window.location.search);
            const highlightTag = urlParams.get('highlight_tag');
            const highlightLocation = urlParams.get('highlight_location');

            window.addEventListener('load', function() {
                if (highlightTag) {
                    const tagDropdown = document.getElementById('tag_dropdown');
                    if (tagDropdown) {
                        tagDropdown.value = highlightTag;
                    }
                }
                if (highlightLocation) {
                    const locationDropdown = document.getElementById('location_dropdown');
                    if (locationDropdown) {
                        locationDropdown.value = highlightLocation;
                    }
                }
                if (highlightTag || highlightLocation) {
                    highlightRooms();
                }

                // Add click listener to map image for room navigation
                const mapImage = document.getElementById('mapimage');
                if (mapImage) {
                    mapImage.addEventListener('click', function(event) {
                        handleMapClick(event);
                    });
                }
            });

            function highlightRooms() {
                const selectedTag = document.getElementById('tag_dropdown').value;
                const selectedLocation = document.getElementById('location_dropdown').value;

                // Remove existing highlight boxes
                const existingHighlights = document.querySelectorAll('.tag_highlight_box, .location_highlight_box, .both_highlight_box');
                existingHighlights.forEach(box => box.remove());

                if (!selectedTag && !selectedLocation) return;

                // Get the original image dimensions
                const imgElement = document.getElementById('mapimage');
                const origWidth = imgElement.naturalWidth;
                const origHeight = imgElement.naturalHeight;

                const widthRatio = currentImageDimensions.width / origWidth;
                const heightRatio = currentImageDimensions.height / origHeight;

                // Process each room
                sameImageRooms.forEach(room => {
                    if (room.image_coords) {
                        const hasTag = selectedTag && room.tags && room.tags.includes(selectedTag);
                        const hasLocation = selectedLocation && room.location === selectedLocation;

                        if (hasTag || hasLocation) {
                            const highlightBox = document.createElement('div');
                            highlightBox.style.position = 'absolute';
                            highlightBox.style.zIndex = '8';

                            // Determine highlight type and class
                            if (hasTag && hasLocation) {
                                highlightBox.className = 'both_highlight_box';
                            } else if (hasTag) {
                                highlightBox.className = 'tag_highlight_box';
                            } else {
                                highlightBox.className = 'location_highlight_box';
                            }

                            // Calculate original dimensions
                            const originalWidth = Math.floor(widthRatio * room.image_coords[2]) - Math.floor(widthRatio * room.image_coords[0]);
                            const originalHeight = Math.floor(heightRatio * room.image_coords[3]) - Math.floor(heightRatio * room.image_coords[1]);

                            // Apply minimum dimensions while maintaining center point
                            const minSize = 10;
                            const finalWidth = Math.max(originalWidth, minSize);
                            const finalHeight = Math.max(originalHeight, minSize);

                            // Calculate position adjustment to maintain center
                            const widthAdjustment = (finalWidth - originalWidth) / 2;
                            const heightAdjustment = (finalHeight - originalHeight) / 2;

                            highlightBox.style.left = (Math.floor(widthRatio * room.image_coords[0]) + 25 - widthAdjustment) + 'px';
                            highlightBox.style.top = (Math.floor(heightRatio * room.image_coords[1]) + 1 - heightAdjustment) + 'px';
                            highlightBox.style.width = finalWidth + 'px';
                            highlightBox.style.height = finalHeight + 'px';
                            highlightBox.title = `Room ${room.id}: ${room.title[0]}`;

                            document.getElementById('image_wrapper').appendChild(highlightBox);
                        }
                    }
                });
            }

            function toggleOpacity() {
                const mapImage = document.getElementById('mapimage');
                const checkbox = document.getElementById('opacity_checkbox');

                if (checkbox.checked) {
                    mapImage.classList.add('opacity_active');
                } else {
                    mapImage.classList.remove('opacity_active');
                }
            }

            function navigateToMap() {
                const dropdown = document.getElementById('map_dropdown');
                const selectedRoomId = dropdown.value;

                if (selectedRoomId) {
                    window.location.href = '/' + selectedRoomId;
                }
            }

            function navigateToAdjacentMap() {
                const dropdown = document.getElementById('adjacent_map_dropdown');
                const selectedRoomId = dropdown.value;

                if (selectedRoomId) {
                    window.location.href = '/' + selectedRoomId;
                }
            }

            function showHelpPopup() {
                document.getElementById('help_popup').style.display = 'flex';
            }

            function hideHelpPopup() {
                document.getElementById('help_popup').style.display = 'none';
            }

            // Hide popup when clicking outside
            document.addEventListener('click', function(event) {
                const popup = document.getElementById('help_popup');
                const popupContent = document.getElementById('help_popup_content');
                const helpIcon = document.getElementById('help_icon');

                if (popup && popup.style.display === 'flex' &&
                    !popupContent.contains(event.target) &&
                    event.target !== helpIcon) {
                    hideHelpPopup();
                }
            });

            function handleMapClick(event) {
                // Get click coordinates relative to the image
                const rect = event.target.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;

                // Get the original image dimensions
                const imgElement = document.getElementById('mapimage');
                const origWidth = imgElement.naturalWidth;
                const origHeight = imgElement.naturalHeight;

                const widthRatio = currentImageDimensions.width / origWidth;
                const heightRatio = currentImageDimensions.height / origHeight;

                // Find which room was clicked
                let clickedRoom = null;
                sameImageRooms.forEach(room => {
                    if (room.image_coords) {
                        // Calculate room boundaries using same logic as highlight boxes
                        const originalX = Math.floor(widthRatio * room.image_coords[0]);
                        const originalY = Math.floor(heightRatio * room.image_coords[1]);
                        const originalWidth = Math.floor(widthRatio * room.image_coords[2]) - Math.floor(widthRatio * room.image_coords[0]);
                        const originalHeight = Math.floor(heightRatio * room.image_coords[3]) - Math.floor(heightRatio * room.image_coords[1]);

                        // Apply minimum dimensions while maintaining center point
                        const minSize = 10;
                        const finalWidth = Math.max(originalWidth, minSize);
                        const finalHeight = Math.max(originalHeight, minSize);

                        // Calculate position adjustment to maintain center
                        const widthAdjustment = (finalWidth - originalWidth) / 2;
                        const heightAdjustment = (finalHeight - originalHeight) / 2;

                        const roomLeft = originalX - widthAdjustment;
                        const roomTop = originalY - heightAdjustment;
                        const roomRight = roomLeft + finalWidth;
                        const roomBottom = roomTop + finalHeight;

                        // Check if click is within this room's boundaries
                        if (clickX >= roomLeft && clickX <= roomRight &&
                            clickY >= roomTop && clickY <= roomBottom) {
                            clickedRoom = room;
                        }
                    }
                });

                if (clickedRoom) {
                    navigateToRoom(clickedRoom.id);
                }
            }

            function navigateToRoom(roomId) {
                // Preserve current highlight selections
                const currentTag = document.getElementById('tag_dropdown') ? document.getElementById('tag_dropdown').value : '';
                const currentLocation = document.getElementById('location_dropdown') ? document.getElementById('location_dropdown').value : '';

                // Build URL with preserved state
                let url = '/' + roomId;
                const params = new URLSearchParams();

                if (currentTag) params.append('highlight_tag', currentTag);
                if (currentLocation) params.append('highlight_location', currentLocation);

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.location.href = url;
            }
        </script>
    </body>
</html>
