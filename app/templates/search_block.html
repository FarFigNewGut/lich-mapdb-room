<div style="max-width: 600px; padding: 10px;">
    <form method="post" action="/search" style="margin-bottom: 15px;">
        <label for="search" style="font-size: 14px; margin-bottom: 5px; display: block;">Room Lich ID, Simu ID, or any search criteria</label>
        <input type="text" name="search" style="width: 100%; padding: 6px; margin-bottom: 8px; font-size: 14px;"
               placeholder="Room Lich ID, Simu ID, or any search criteria"
               value="{{ request.form['search'] }}">
        <button type="submit" style="padding: 6px 12px; font-size: 14px;">Search</button>
    </form>

    <hr style="margin: 15px 0;">

    <form method="post" action="/search" id="tagSearchForm">
        <label style="font-size: 14px; margin-bottom: 8px; display: block;">Advanced Search by Tag and Map:</label>

        <div style="margin-bottom: 10px;">
            <input type="text" name="tag" id="tagInput" placeholder="Start typing a tag..." autocomplete="off"
                   style="width: 100%; padding: 6px; font-size: 14px;">
            <div id="tagSuggestions" style="display: none; border: 1px solid #ccc; background: white; max-height: 150px; overflow-y: auto; position: absolute; z-index: 1000; font-size: 14px;"></div>
        </div>

        <div style="margin-bottom: 10px;">
            <select name="image" id="imageSelect" disabled style="width: 100%; padding: 6px; font-size: 14px;">
                <option value="">Select a map...</option>
            </select>
        </div>

        <div style="margin-bottom: 10px;">
            <select name="location" id="locationSelect" disabled style="width: 100%; padding: 6px; font-size: 14px;">
                <option value="">Select a location (optional)...</option>
            </select>
        </div>

        <button type="submit" id="tagSearchButton" disabled style="padding: 6px 12px; font-size: 14px;">Go to Map</button>
    </form>

    <script>
        const tagInput = document.getElementById('tagInput');
        const tagSuggestions = document.getElementById('tagSuggestions');
        const imageSelect = document.getElementById('imageSelect');
        const locationSelect = document.getElementById('locationSelect');
        const tagSearchButton = document.getElementById('tagSearchButton');
        let allTags = [];

        // Load tags on page load
        fetch('/api/tags')
            .then(response => response.json())
            .then(tags => {
                allTags = tags;
            });

        // Handle tag input
        tagInput.addEventListener('input', function() {
            const inputValue = this.value.toLowerCase();

            // Reset image and location dropdowns
            imageSelect.innerHTML = '<option value="">Select a map...</option>';
            imageSelect.disabled = true;
            locationSelect.innerHTML = '<option value="">Select a location (optional)...</option>';
            locationSelect.disabled = true;
            tagSearchButton.disabled = true;

            if (inputValue.length > 0) {
                const filteredTags = allTags.filter(tag =>
                    tag.toLowerCase().includes(inputValue)
                );

                if (filteredTags.length > 0) {
                    showSuggestions(filteredTags);
                } else {
                    hideSuggestions();
                }
            } else {
                hideSuggestions();
            }
        });

        // Handle tag selection from suggestions
        function selectTag(tag) {
            tagInput.value = tag;
            hideSuggestions();
            loadImagesForTag(tag);
        }

        // Show suggestions
        function showSuggestions(tags) {
            tagSuggestions.innerHTML = '';
            tags.forEach(tag => {
                const div = document.createElement('div');
                div.textContent = tag;
                div.style.padding = '4px 8px';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.style.color = '#333';
                div.addEventListener('click', () => selectTag(tag));
                div.addEventListener('mouseenter', () => div.style.backgroundColor = '#0066cc');
                div.addEventListener('mouseenter', () => div.style.color = 'white');
                div.addEventListener('mouseleave', () => div.style.backgroundColor = 'white');
                div.addEventListener('mouseleave', () => div.style.color = '#333');
                tagSuggestions.appendChild(div);
            });
            tagSuggestions.style.display = 'block';
        }

        // Hide suggestions
        function hideSuggestions() {
            tagSuggestions.style.display = 'none';
        }

        // Load images for selected tag
        function loadImagesForTag(tag) {
            if (tag) {
                fetch(`/api/images/${encodeURIComponent(tag)}`)
                    .then(response => response.json())
                    .then(images => {
                        images.forEach(image => {
                            const option = document.createElement('option');
                            option.value = image;
                            option.textContent = image;
                            imageSelect.appendChild(option);
                        });
                        imageSelect.disabled = false;
                    });
            }
        }

        // Load locations for selected tag and image
        function loadLocationsForTagAndImage(tag, image) {
            if (image) {
                const url = `/api/locations/${encodeURIComponent(image)}${tag ? `?tag=${encodeURIComponent(tag)}` : ''}`;
                fetch(url)
                    .then(response => response.json())
                    .then(locations => {
                        locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location;
                            option.textContent = location;
                            locationSelect.appendChild(option);
                        });
                        locationSelect.disabled = false;
                    });
            }
        }

        // Handle image selection
        imageSelect.addEventListener('change', function() {
            const selectedImage = this.value;

            // Reset location dropdown
            locationSelect.innerHTML = '<option value="">Select a location (optional)...</option>';
            locationSelect.disabled = true;

            if (selectedImage) {
                // Load locations for selected tag and image combination
                const selectedTag = tagInput.value;
                loadLocationsForTagAndImage(selectedTag, selectedImage);
                tagSearchButton.disabled = false;
            } else {
                tagSearchButton.disabled = true;
            }
        });

        // Handle blur to hide suggestions
        tagInput.addEventListener('blur', function() {
            setTimeout(() => hideSuggestions(), 100);
        });

        // Handle enter key to select first suggestion
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const firstSuggestion = tagSuggestions.querySelector('div');
                if (firstSuggestion) {
                    selectTag(firstSuggestion.textContent);
                }
            }
        });
    </script>
    {% if not results and results != None %}
    <div><h3>No rooms found, check your search and try again.</h3></div>
    {% endif %}
    {% if overflow %}
    <div><h3>You matched a lot of results, only returning the first 100. Try narrowing your search</h3></div>
    {% endif %}
    {% if results %}
    <div>
    {% for rid, rinfo in results.items() -%}
    <br><a href="{{ url_for('room_page', room_id=rid) }}">{{ rid }} - {{ rinfo.get('uid', ['None'])[0] }} - {{ rinfo['title'][0] }}</a><br>
    {% endfor %}
    {% endif %}
    </div>
</div>
